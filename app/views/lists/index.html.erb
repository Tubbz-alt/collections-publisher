<h1>Curated lists for "<%= @topic.title %>"<%= " (draft)" if @topic.draft? %></h1>

<% if @topic.untagged_list_items.any? %>
  <div class='untagged-list-items subtle-highlight'>
    <p>
      <strong>Warning</strong>: this content has been curated but is not tagged to this topic.
      Please either remove it or re-tag it to the topic.
    </p>

    <table class='table table-hover'>
      <thead>
        <tr>
          <th class='title'>Title</th>
        </tr>
      </thead>

      <tbody>
        <% @topic.untagged_list_items.each do |list_item| %>
          <tr>
            <td class='title'><%= list_item.title %></td>
            <td class='remove'>
              <%= button_to 'Remove', topic_list_list_item_path(@topic, list_item.list, list_item),
                method: :delete, class: 'btn btn-sm btn-danger' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<% unless @topic.draft? %>
  <p>
    <%= button_to 'Publish changes to GOV.UK', republish_topic_path(@topic),
          method: :post,
          class: "btn btn-success publish btn-lg js-confirm",
          :'data-confirm-text' => "Are you sure you want to publish this immediately to GOV.UK?",
          disabled: !@topic.dirty?
    %>
  </p>
<% end %>

<%= form_for(List.new, url: topic_lists_path(@topic), html: {id: 'new-list'}) do |f| %>
  <h2>New list</h2>
  <%= f.text_field :name %>

  <button class='btn-submit'>Create</button>
<% end %>

<div class="curated-lists">
  <% @lists.each do |list| %>
    <section
      class="list"
      aria-labelledby='list-<%= list.id %>-header'
      id='list-<%= list.id %>-section'
      data-index='<%= list.index %>'
      data-update-url='<%= topic_list_path(@topic, list) %>'>
      <h2 id='list-<%= list.id %>-header'><%= list.name %></h2>
      <ul>
        <li><%= link_to 'Edit name', edit_topic_list_path(@topic, list) %></li>
        <li>
          <%= button_to 'Delete list', topic_list_path(@topic, list),
                method: :delete,
                class: 'js-confirm btn btn-sm btn-danger',
                :'data-confirm-text' => 'Are you sure you want to delete this list and all its content?'
          %>
        </li>
      </ul>

      <table class='table table-hover'>
        <thead>
          <tr>
            <th class='index'>Index</th>
            <th class='title'>Title</th>
            <th class='api-url' colspan='2'>API URL</th>
          </tr>
        </thead>

        <tbody class='curated-list' data-list-id='<%= list.id %>'>
          <tr class='empty-list'><td>Empty</td></tr>
          <% list.tagged_list_items.each do |list_item| %>
            <tr
              data-update-url='<%= topic_list_list_item_path(@topic, list, list_item) %>'
              data-index='<%= list_item.index %>'
              data-list-id='<%= list.id %>'
            >
              <td class='index'><%= list_item.index %></td>
              <td class='title'><%= list_item.title %></td>
              <td class='api-url'><%= list_item.api_url %></td>
              <td class='remove'><%= button_to 'Remove', topic_list_list_item_path(@topic, list, list_item), method: :delete %></td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <%= form_for(ListItem.new, url: topic_list_list_items_path(@topic, list), html: {id: nil}) do |f| %>
        <%= f.text_field :api_url, label: 'API URL' %>
        <%= f.number_field :index %>

        <button class='btn btn-primary'>Add</button>
      <% end %>
    </section>
  <% end %>
</div>

<section class="list" aria-labelledby='list-uncategorized-header' id='list-uncategorized-section'>
  <h2 id='list-uncategorized-header'>Uncategorized (A to Z)</h2>
  <%- if @lists.any? -%>
    <p><b>Note:</b> These will not be displayed to users</p>
  <%- end -%>

  <table class='table table-hover'>
    <thead>
      <tr>
        <td class='title'>Title</th>
        <th class='api-url'>API URL</th>
      </tr>
    </thead>

    <tbody class='curated-list'>
      <tr class='empty-list'><td colspan='2'>Empty</td></tr>
      <% @topic.uncategorized_list_items.each do |list_item| %>
        <tr>
          <td class='title'><%= list_item.title %></td>
          <td class='api-url'><%= list_item.api_url %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</section>
